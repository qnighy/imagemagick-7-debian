From 1e59e000ecae2523e707242621738da27d0d6296 Mon Sep 17 00:00:00 2001
From: Zhang Xiaohui <ruc_zhangxiaohui@163.com>
Date: Tue, 2 Feb 2021 16:10:05 +0800
Subject: [PATCH] fix division by zero in WriteJP2Image() in coders/jp2.c

---
 coders/jp2.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

--- imagemagick-6.9.11.60+dfsg.orig/coders/jp2.c
+++ imagemagick-6.9.11.60+dfsg/coders/jp2.c
@@ -1064,8 +1064,8 @@ static MagickBooleanType WriteJP2Image(c
 
         scale=(double) (((size_t) 1UL << jp2_image->comps[i].prec)-1)/
           QuantumRange;
-        q=jp2_image->comps[i].data+(y/jp2_image->comps[i].dy*
-          image->columns/jp2_image->comps[i].dx+x/jp2_image->comps[i].dx);
+        q=jp2_image->comps[i].data+(ssize_t) (y*PerceptibleReciprocal(jp2_image->comps[i].dy)*
+          image->columns*PerceptibleReciprocal(jp2_image->comps[i].dx)+x*PerceptibleReciprocal(jp2_image->comps[i].dx));
         switch (i)
         {
           case 0:

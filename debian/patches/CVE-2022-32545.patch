From 450949ed017f009b399c937cf362f0058eacc5fa Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sat, 19 Mar 2022 07:01:57 -0400
Subject: [PATCH] Pull request:
 https://github.com/ImageMagick/ImageMagick/pull/4963

---
 coders/emf.c    | 3 ++-
 coders/psd.c    | 5 +++--
 magick/widget.c | 6 ++++++
 wand/animate.c  | 5 ++++-
 wand/display.c  | 5 ++++-
 5 files changed, 19 insertions(+), 5 deletions(-)

--- imagemagick-6.9.11.60+dfsg.orig/coders/emf.c
+++ imagemagick-6.9.11.60+dfsg/coders/emf.c
@@ -411,7 +411,8 @@ static HENHMETAFILE ReadEnhMetaFile(cons
     }
   ReadFile(hFile,pBits,dwSize,&dwSize,NULL);
   CloseHandle(hFile);
-  if (((PAPMHEADER) pBits)->dwKey != 0x9ac6cdd7l)
+  if (((PAPMHEADER) pBits)->dwKey != 0x9ac6cdd7l ||
+      (((PAPMHEADER) pBits)->wInch == 0))
     {
       pBits=(BYTE *) DestroyString((char *) pBits);
       return((HENHMETAFILE) NULL);
--- imagemagick-6.9.11.60+dfsg.orig/coders/psd.c
+++ imagemagick-6.9.11.60+dfsg/coders/psd.c
@@ -1045,8 +1045,9 @@ static MagickBooleanType ReadPSDChannelP
           number_bits=8;
         for (bit=0; bit < number_bits; bit++)
         {
-          SetPSDPixel(image,channels,type,packet_size,(((unsigned char) pixel)
-            & (0x01 << (7-bit))) != 0 ? 0 : QuantumRange,q++,indexes,x++);
+          SetPSDPixel(image,channels,type,packet_size,
+            (((unsigned char) ((ssize_t) pixel)) & (0x01 << (7-bit))) != 0 ? 0 :
+            QuantumRange,q++,indexes,x++);
         }
         if (x != (ssize_t) image->columns)
           x--;
--- imagemagick-6.9.11.60+dfsg.orig/magick/widget.c
+++ imagemagick-6.9.11.60+dfsg/magick/widget.c
@@ -7858,6 +7858,8 @@ MagickExport int XMenuWidget(Display *di
             break;
           }
         state&=(~InactiveWidgetState);
+        if (selection_info.height == 0)
+          break;
         id=(event.xbutton.y-top_offset)/(int) selection_info.height;
         selection_info.id=id;
         if ((id < 0) || (id >= (int) number_selections))
@@ -7911,6 +7913,8 @@ MagickExport int XMenuWidget(Display *di
         if (event.xcrossing.state == 0)
           break;
         state&=(~InactiveWidgetState);
+        if (selection_info.height == 0)
+          break;
         id=((event.xcrossing.y-top_offset)/(int) selection_info.height);
         if ((selection_info.id >= 0) &&
             (selection_info.id < (int) number_selections))
@@ -7997,6 +8001,8 @@ MagickExport int XMenuWidget(Display *di
           break;
         if (state & InactiveWidgetState)
           break;
+        if (selection_info.height == 0)
+          break;
         id=(event.xmotion.y-top_offset)/(int) selection_info.height;
         if ((selection_info.id >= 0) &&
             (selection_info.id < (int) number_selections))
--- imagemagick-6.9.11.60+dfsg.orig/wand/animate.c
+++ imagemagick-6.9.11.60+dfsg/wand/animate.c
@@ -1143,7 +1143,10 @@ WandExport MagickBooleanType AnimateImag
             if (i == (ssize_t) argc)
               ThrowAnimateException(OptionError,"MissingArgument",option);
             if (XRemoteCommand(display,resource_info.window_id,argv[i]) != 0)
-              return(MagickFalse);
+              {
+                DestroyAnimate();
+                return(MagickFalse);
+              }
             i--;
             break;
           }
--- imagemagick-6.9.11.60+dfsg.orig/wand/display.c
+++ imagemagick-6.9.11.60+dfsg/wand/display.c
@@ -1491,7 +1491,10 @@ WandExport MagickBooleanType DisplayImag
             if (i == (ssize_t) argc)
               ThrowDisplayException(OptionError,"MissingArgument",option);
             if (XRemoteCommand(display,resource_info.window_id,argv[i]) != 0)
-              return(MagickFalse);
+              {
+                DestroyDisplay();
+                return(MagickFalse);
+              }
             i--;
             break;
           }
